<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Hiking Route - Persistent Storage</title>
<script src='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js'></script>
<link href='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css' rel='stylesheet' />
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100vw; height: 100vh; background-color: #e0e0e0; }
        .overlay {
            position: absolute; top: 15px; left: 15px; z-index: 10;
            background: rgba(255, 255, 255, 0.9); padding: 15px; 
            border-radius: 10px; font-family: sans-serif;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-width: 250px;
        }
    </style>
</head>
<body>
    <div class="overlay">
        <h3 style="margin-top:0">Kylemore Waterfall Trail</h3>
        <div id="info">Click the map to add a waypoint.</div>
        <button onclick="clearUserPoints()" style="margin-top:10px; cursor:pointer;">Clear My Waypoints</button>
    </div>

    <div id="map"></div>

    <script>
        // 1. DATA INITIALIZATION
        const savedData = localStorage.getItem('hiking_user_waypoints');
        let userWaypoints = savedData ? JSON.parse(savedData) : {
            "type": "FeatureCollection",
            "features": []
        };

        const hikeWaypoints = {
            "type": "FeatureCollection",
            "features": [
                { "type": "Feature", "geometry": { "type": "Point", "coordinates": [18.970347, -33.926401] }, "properties": { "name": "First Split", "desc": "Steep ascent begins." } },
                { "type": "Feature", "geometry": { "type": "Point", "coordinates": [18.972991, -33.9263] }, "properties": { "name": "The Upper turn", "desc": "Halfway mark!" } },
                { "type": "Feature", "geometry": { "type": "Point", "coordinates": [18.97644 ,-33.9293]}, "properties": { "name": "WaterFall", "desc": "The highest point." } }
            ]
        };

        // 2. MAP INITIALIZATION (CRITICAL: Ensure the 'style' is fully defined here)
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                "version": 8,
                "sources": {
                    "osm-tiles": {
    "type": "raster",
    "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], // Added / after .org
    "tileSize": 256,
    "attribution": "&copy; OpenStreetMap contributors"
}

                },
                "layers": [{
                    "id": "base-layer",
                    "type": "raster",
                    "source": "osm-tiles"
                }]
            },
            center: [18.970347, -33.926401], // Kylemore  coordinates
            zoom: 13
        });


        map.on('load', () => {
            // 3. ADD SOURCES
            map.addSource('hike-pts', { type: 'geojson', data: hikeWaypoints });
            map.addSource('user-pts', { type: 'geojson', data: userWaypoints });

            // 4. ADD LAYERS
            map.addLayer({
                id: 'poi-layer',
                type: 'circle',
                source: 'hike-pts',
                paint: { 'circle-radius': 10, 'circle-color': '#FF5252', 'circle-stroke-width': 2, 'circle-stroke-color': '#fff' }
            });

            map.addLayer({
                id: 'user-layer',
                type: 'circle',
                source: 'user-pts',
                paint: { 'circle-radius': 8, 'circle-color': '#3bb2d0', 'circle-stroke-width': 2, 'circle-stroke-color': '#fff' }
            });

            // 5. INTERACTION
            map.on('click', (e) => {
                // Prevent adding a new point if you click an existing one
                const features = map.queryRenderedFeatures(e.point, { layers: ['poi-layer', 'user-layer'] });
                if (features.length > 0) return;

                const coords = [e.lngLat.lng, e.lngLat.lat];
                const newPoint = {
                    "type": "Feature",
                    "geometry": { "type": "Point", "coordinates": coords },
                    "properties": { "name": "User Waypoint", "desc": "Saved locally", "id": Date.now() }
                };

                userWaypoints.features.push(newPoint);
                map.getSource('user-pts').setData(userWaypoints);
                
                // Save to localStorage
                localStorage.setItem('hiking_user_waypoints', JSON.stringify(userWaypoints));
            });

            // Show popups for points
            map.on('click', 'poi-layer', (e) => {
                const props = e.features[0].properties;
                new maplibregl.Popup().setLngLat(e.lngLat).setHTML(`<b>${props.name}</b><br>${props.desc}`).addTo(map);
            });
            
            map.on('mouseenter', 'poi-layer', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'poi-layer', () => map.getCanvas().style.cursor = '');
        });

        // Helper to clear the local storage
        function clearUserPoints() {
            if(confirm("Delete all your custom waypoints?")) {
                localStorage.removeItem('hiking_user_waypoints');
                userWaypoints.features = [];
                map.getSource('user-pts').setData(userWaypoints);
            }
        }
    </script>
</body>
</html>
